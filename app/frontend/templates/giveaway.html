{% extends "base.html" %}

{% block header %}
<link rel="stylesheet" href="{{ url_for('static', path='giveaway.css') }}">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
{% endblock %}

{% block content %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content giveaway-bg">
    <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom border-secondary">
        <h1 class="h2 text-white"><i class="bi bi-gift-fill text-warning me-2"></i> Tirage au Sort <span
                class="badge bg-danger fs-6 align-middle">PRO</span></h1>
    </div>

    <div class="row g-4 giveaway-container">
        <!-- LEFT PANEL: Info & Platform Switch -->
        <div class="col-lg-4">
            <!-- Platform Toggle -->
            <div class="card premium-card mb-4">
                <div class="card-body text-center p-4">
                    <h5 class="text-white mb-4">Platforme</h5>
                    <div class="btn-group btn-group-lg w-100" role="group">
                        <input type="radio" class="btn-check" name="platform_btn" id="btn_fb" autocomplete="off" checked
                            onchange="switchPlatform('facebook')">
                        <label class="btn btn-outline-primary fw-bold" for="btn_fb"><i class="bi bi-facebook me-2"></i>
                            Facebook</label>

                        <input type="radio" class="btn-check" name="platform_btn" id="btn_ig" autocomplete="off"
                            onchange="switchPlatform('instagram')">
                        <label class="btn btn-outline-danger fw-bold" for="btn_ig"><i class="bi bi-instagram me-2"></i>
                            Instagram</label>
                    </div>
                </div>
            </div>

            <!-- Login / Account Status -->
            <div class="card premium-card mb-4">
                <div class="card-body p-4 text-center">

                    {% if request.session.get('fb_access_token') %}
                    <div class="badge bg-success text-white fs-6 mb-3"><i class="bi bi-link"></i> Live Meta API
                        Connected</div>
                    <img src="{{ url_for('static', path='logo.png') }}" alt="Logo" class="img-fluid mb-3"
                        style="max-height: 80px;">
                    <h5 class="text-white">Account Linked</h5>
                    <p class="text-muted small">You can now fetch real comments from your Facebook/Instagram pages.</p>
                    <a href="/giveaways/auth/logout" class="btn btn-outline-danger w-100 fw-bold mt-2">
                        <i class="bi bi-box-arrow-right me-2"></i> Disconnect
                    </a>
                    {% else %}
                    <div id="demo-badge" class="badge bg-warning text-dark fs-6 mb-3"><i
                            class="bi bi-lightning-fill"></i> API Demo Mode</div>
                    <img src="{{ url_for('static', path='logo.png') }}" alt="Logo" class="img-fluid mb-3"
                        style="max-height: 80px;">
                    <h5 class="text-white">Connexion required for Live Data</h5>
                    <p class="text-muted small">Log in as admin of the page and grant read permissions to fetch real
                        posts and comments.</p>
                    <a href="/giveaways/auth/login" class="btn btn-primary w-100 fw-bold">
                        <i class="bi bi-facebook me-2"></i> Login with Meta
                    </a>
                    <p class="text-success small mt-3 fw-bold"><i class="bi bi-check-circle-fill"></i> Using Simulated
                        Data until connected.</p>
                    {% endif %}

                </div>
            </div>

            <!-- Features List -->
            <div class="card premium-card">
                <div class="card-body p-4">
                    <h6 class="text-white mb-3">Fonctionnalit√©s</h6>
                    <ul class="list-unstyled text-light mb-0 feature-list">
                        <li><i class="bi bi-check2 text-success"></i> Multiple posts selection</li>
                        <li><i class="bi bi-check2 text-success"></i> Multiple winners (Max 10)</li>
                        <li><i class="bi bi-check2 text-success"></i> Filter duplicate users</li>
                        <li><i class="bi bi-check2 text-success"></i> Require @mentions</li>
                        <li><i class="bi bi-check2 text-success"></i> Require specific #hashtag</li>
                        <li><i class="bi bi-check2 text-success"></i> Epic Slot-Machine Animation</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Settings -->
        <div class="col-lg-8">
            <div class="card premium-card mb-4">
                <div class="card-header bg-transparent border-secondary text-white fw-bold">
                    <i class="bi bi-gear-fill me-2"></i> Param√®tres du Tirage
                </div>
                <div class="card-body p-4">

                    {% if request.cookies.get('fb_token') or request.session.get('fb_access_token') %}
                    <!-- Live Post Selection Flow -->
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label text-light fw-bold fs-6">1. S√©lectionner la Page</label>
                        <div class="col-sm-9">
                            <select id="page-selector" class="form-select premium-input form-select-lg shadow-sm"
                                onchange="loadPagePosts(this.value)">
                                <option value="" selected disabled>Select a page...</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mb-4">
                        <label class="col-sm-3 col-form-label text-light fw-bold fs-6">2. S√©lectionner les Posts</label>
                        <div class="col-sm-9">
                            <div class="premium-post-trigger" onclick="openPostModal()">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-circle bg-warning text-dark me-3">
                                            <i class="bi bi-collection-play-fill fs-5"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 text-white">Choisir les Publications</h6>
                                            <small id="selection-summary" class="text-warning fw-bold">0 publication
                                                s√©lectionn√©e</small>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Section -->
                    <h6 class="text-warning mb-3 border-bottom border-secondary pb-2">Filtres et R√®gles</h6>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="filter_duplicates" checked>
                                <label class="form-check-label text-light" for="filter_duplicates">Ignorer les
                                    doublons</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="include_replies">
                                <label class="form-check-label text-light" for="include_replies">Inclure les
                                    r√©ponses</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require_like">
                                <label class="form-check-label text-info" for="require_like">Doit avoir aim√© le post
                                    <span class="badge bg-danger ms-1" style="font-size:0.6rem;">Premium</span></label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require_photo">
                                <label class="form-check-label text-light" for="require_photo">Doit contenir une
                                    photo</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="filter_date_toggle"
                                    onchange="document.getElementById('date_range_wrapper').style.display = this.checked ? 'block' : 'none'">
                                <label class="form-check-label text-light" for="filter_date_toggle">Filtrer par date
                                    limite</label>
                            </div>
                            <div id="date_range_wrapper" style="display: none;" class="mt-2">
                                <div class="d-flex gap-2">
                                    <input type="date" id="start_date"
                                        class="form-control form-control-sm premium-input" title="Date de D√©but">
                                    <input type="date" id="end_date" class="form-control form-control-sm premium-input"
                                        title="Date de Fin">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Mentions Requises (@)</label>
                            <select id="min_mentions" class="form-select premium-input">
                                <option value="0">Aucune</option>
                                <option value="1">1 mention (ex: @ami)</option>
                                <option value="2">2 mentions (ex: @ami1 @ami2)</option>
                                <option value="3">3 mentions minimum</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Mot ou Hashtag Requis</label>
                            <input type="text" id="required_word" class="form-control premium-input"
                                placeholder="ex: #ConcoursZaher">
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Minimum de Likes (Commentaire)</label>
                            <input type="number" id="min_comment_likes" class="form-control premium-input" value="0"
                                min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Max d'entr√©es / participant (üí° si Ignorer
                                doublons est off)</label>
                            <input type="number" id="max_entries_per_user" class="form-control premium-input"
                                placeholder="ex: 5 (vide = illimit√©)" min="1">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Exclure des Utilisateurs <span
                                    class="badge bg-secondary ms-1" style="font-size:0.6rem;">Noms s√©par√©s par
                                    virgule</span></label>
                            <textarea id="excluded_users" class="form-control premium-input" rows="2"
                                placeholder="ex: admin, spammer"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-light mb-1">Entr√©es Suppl√©mentaires <span
                                    class="badge bg-warning text-dark ms-1" style="font-size:0.6rem;">Noms
                                    VIP</span></label>
                            <textarea id="extra_entries" class="form-control premium-input" rows="2"
                                placeholder="ex: vip_user1, vip_user2"></textarea>
                        </div>
                    </div>

                    <!-- Raffle Settings -->
                    <h6 class="text-warning mb-3 mt-4 border-bottom border-secondary pb-2">Param√®tres des Gagnants &
                        R√©sultats</h6>
                    <div class="row align-items-end mb-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label text-light mb-1">Nombre de Gagnants</label>
                            <input type="number" id="num_winners" class="form-control premium-input" value="1" min="1"
                                max="10">
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label text-light mb-1">Dur√©e de l'Animation</label>
                            <select id="animation_duration" class="form-select premium-input">
                                <option value="3">3 Secondes</option>
                                <option value="5" selected>5 Secondes</option>
                                <option value="10">10 Secondes</option>
                            </select>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-warning btn-lg fw-bold w-100 magic-button" onclick="startDraw()">
                                <i class="bi bi-play-circle-fill me-2"></i> LANCER LE TIRAGE
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTS PANEL (Hidden initially) -->
            <div id="results-panel" class="card premium-card border-warning" style="display: none;">
                <div class="card-header bg-warning text-dark fw-bold text-center fs-5">
                    <i class="bi bi-trophy-fill me-2"></i> R√©sultats du Tirage
                </div>
                <div class="card-body p-5">

                    <!-- Winner Display Area -->
                    <div id="winner-reveal-area" class="text-center">
                        <!-- Loaded dynamically via JS -->
                    </div>

                </div>
            </div>

        </div>
    </div>
</main>

<!-- Premium Posts Modal -->
<div class="modal fade glass-modal" id="postsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content premium-modal-content">
            <div class="modal-header border-bottom border-secondary p-4 pb-3">
                <h5 class="modal-title text-white fw-bold"><i class="bi bi-grid-3x3-gap-fill text-warning me-2"></i>
                    S√©lection des Publications</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body p-4 custom-scrollbar bg-dark-subtle">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted small">Cliquez sur les publications que vous souhaitez inclure dans le
                        tirage. Les commentaires seront fusionn√©s.</span>
                    <button class="btn btn-sm btn-outline-warning fw-bold" onclick="selectAllPosts()"><i
                            class="bi bi-check-all"></i> Tout S√©lectionner</button>
                </div>

                <div id="post-grid" class="post-gallery-grid">
                    <div class="text-muted text-center p-5 w-100 col-12">
                        <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                        Veuillez d'abord s√©lectionner une page dans les param√®tres.
                    </div>
                </div>
            </div>

            <div class="modal-footer border-top border-secondary p-3">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div id="modal-selection-count" class="text-warning fw-bold">0 s√©lectionn√©e</div>
                    <button type="button" class="btn btn-warning fw-bold px-4" data-bs-dismiss="modal"
                        onclick="updateSelectionSummary()">Valider la S√©lection</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Overlay Animation (Slot Machine) -->
<div id="slot-machine-overlay" class="slot-overlay d-flex justify-content-center align-items-center"
    style="display: none !important;">
    <div class="slot-container text-center">
        <h2 class="text-warning mb-4" id="slot-title">Recherche des Gagnants...</h2>
        <div class="slot-window bg-dark border border-warning rounded p-4 shadow-lg">
            <div id="slot-reel" class="slot-reel text-white fs-2 fw-bold">
                <!-- Rolling names go here -->
                <div class="slot-item">Chargement des commentaires...</div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='giveaway.js') }}"></script>
{% endblock %}