{% extends "base.html" %}

{% block content %}
<h2 class="page-title"><i class="fa-solid fa-money-bill-transfer"></i> Gestion des Avances</h2>

<div class="card form-card">
    <h3><i class="fa-solid fa-plus"></i> Ajouter une Avance</h3>
    <form method="post" action="{{ request.url_for('deposits_create') }}">
      <div class="form-row">
        <div class="form-group">
          <label for="employee_id">Employé</label>
          {# --- FIX: Apply form-select class --- #}
          <select id="employee_id" name="employee_id" class="form-select" required>
             <option value="" disabled selected>-- Choisir un employé --</option>
            {% for e in employees %}
            <option value="{{ e.id }}">{{ e.first_name }} {{ e.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="amount">Montant (TND)</label>
          {# --- FIX: Apply form-control class --- #}
          <input type="text" id="amount" name="amount" class="form-control" required placeholder="Ex: 150.50"
                 pattern="^\d+([.,]\d{1,2})?$"
                 title="Montant positif, ex: 150 ou 150.50 ou 150,50">
        </div>
      </div>
      <div class="form-row">
         <div class="form-group">
          <label for="date">Date de l'Avance</label>
          {# --- FIX: Apply form-control class --- #}
          <input type="date" id="date" name="date" class="form-control" required value="{{ today_date }}">
        </div>
        <div class="form-group">
          <label for="note">Note (Optionnel)</label>
          {# --- FIX: Apply form-control class --- #}
          <input type="text" id="note" name="note" class="form-control" placeholder="Raison, référence...">
        </div>
      </div>
      <div class="form-actions" style="margin-top: 1rem;"> {# Added margin-top #}
        <button type="submit" class="btn btn-success">
            <i class="fa-solid fa-save"></i> Enregistrer Avance
        </button>
      </div>
    </form>
</div>

<!-- Sync Button and Modal -->
<div class="card form-card" style="margin-top: 1.5rem;">
    <h3><i class="fa-solid fa-sync"></i> Synchronisation Compta</h3>
    <p>Synchroniser les avances d'aujourd'hui vers l'ancien logiciel.</p>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#syncModal">
        <i class="fa-solid fa-database"></i> Synchroniser vers Compta
    </button>
</div>

<!-- Sync Modal -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content card">
      <div class="modal-header">
        <h5 class="modal-title" id="syncModalLabel">Synchronisation Base de Données</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
      </div>
      <div class="modal-body">
        <form id="syncForm">
            <div class="form-group mb-3">
                <label for="syncHost">Serveur (Host)</label>
                <input type="text" class="form-control" id="syncHost" value="localhost" required>
            </div>
            <div class="form-group mb-3">
                <label for="syncSchema">Nom de la Base (Schema)</label>
                <input type="text" class="form-control" id="syncSchema" placeholder="ex: birkal" required>
            </div>
             <div class="form-group mb-3">
                <label for="syncPassword">Mot de Passe DB</label>
                <input type="password" class="form-control" id="syncPassword" value="6165" required>
            </div>
            <div id="syncResult" class="mt-3"></div>
        </form>
      </div>
      <div class="modal-footer form-actions">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" onclick="performSync()">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<script>
async function performSync() {
    const host = document.getElementById('syncHost').value;
    const schema = document.getElementById('syncSchema').value;
    const password = document.getElementById('syncPassword').value;
    const resultDiv = document.getElementById('syncResult');
    
    if (!schema) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Veuillez entrer le nom de la base (Schema).</div>';
        return;
    }

    resultDiv.innerHTML = '<div class="alert alert-info">Synchronisation en cours...</div>';
    
    try {
        const response = await fetch('/api/deposits/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                host: host,
                schema_name: schema,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
             resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
             resultDiv.innerHTML = `<div class="alert alert-danger">Erreur: ${data.message}</div>`;
        }
        
    } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = '<div class="alert alert-danger">Erreur de connexion au serveur.</div>';
    }
}
</script>


<div class="card table-card" style="margin-top: 1.5rem;"> {# Added margin-top #}
    <h3><i class="fa-solid fa-list-ul"></i> Avances Récentes</h3>
    {% if deposits %}
    <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Employé</th>
              <th>Date</th>
              <th>Montant (TND)</th>
              <th>Note</th>
              <th>Enregistré le</th>
              {# --- NOUVEAU: Colonne Actions (Admin seulement) --- #}
              {% if user.permissions.is_admin %}
                <th>Actions</th>
              {% endif %}
            </tr>
           </thead>
           <tbody>
            {% for d in deposits %}
            <tr>
              <td>{{ d.id }}</td>
              <td>
                  {# --- Utiliser la relation chargée --- #}
                 {% if d.employee %}
                    {{ d.employee.first_name }} {{ d.employee.last_name }}
                 {% else %}
                    Employé ID: {{ d.employee_id }} (Non trouvé)
                 {% endif %}
              </td>
              <td>{{ d.date.strftime('%Y-%m-%d') }}</td>
              <td class="amount">{{ "%.2f"|format(d.amount|float) }}</td>
              <td>{{ d.note or '-' }}</td>
              <td class="timestamp">{{ d.created_at | to_tunisia }}</td>
              {# --- NOUVEAU: Bouton Supprimer (Admin seulement) --- #}
              {% if user.permissions.is_admin %}
              <td>
                 <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteDepositModal-{{ d.id }}">
                   Supprimer
                 </button>
              </td>
              {% endif %}
              {# --- FIN NOUVEAU --- #}
            </tr>
            {% endfor %}
           </tbody>
        </table>
    </div>
    {# --- Modals moved outside the table card below --- #}
    {% else %}
        <p class="no-data" style="padding-top: 1rem;">Aucune avance enregistrée à afficher.</p> {# Added padding #}
    {% endif %}
</div> {# <-- End of card table-card div --> #}

{# --- NOUVEAU: Modals de Confirmation (Admin seulement) --- #}
{% if user.permissions.is_admin and deposits %} {# Check if user is admin and deposits exist #}
  {% for d in deposits %}
  <div class="modal fade" id="deleteDepositModal-{{ d.id }}" tabindex="-1" aria-labelledby="deleteDepositModalLabel-{{ d.id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content card"> {# Apply card style to modal #}
        <form action="{{ url_for('deposits_delete', deposit_id=d.id) }}" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteDepositModalLabel-{{ d.id }}">Confirmer la Suppression</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
          </div>
          <div class="modal-body">
            <p>Êtes-vous sûr de vouloir supprimer l'avance de
               <strong>{{ "%.2f TND"|format(d.amount|float) }}</strong> du
               <strong>{{ d.date.strftime('%Y-%m-%d') }}</strong> pour
               <strong>{{ d.employee.first_name ~ ' ' ~ d.employee.last_name if d.employee else 'Employé ID:' ~ d.employee_id }}</strong> ?
            </p>
            <p class="text-danger">Cette action est irréversible.</p>
          </div>
          <div class="modal-footer form-actions">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Oui, Supprimer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
{% endif %}
{# --- FIN NOUVEAU --- #}

{% endblock %}
