{% extends "base.html" %}

{% block content %}
<h2 class="page-title"><i class="fa-solid fa-users"></i> Gestion des Employés</h2>

{% if user.permissions.is_admin %}
<div class="card form-card mb-4" style="border-left: 5px solid #2196f3;">
  <h3><i class="fa-solid fa-filter"></i> Filtrer par Magasin (Admin)</h3>
  <form method="get" action="{{ request.url_for('employees_page') }}">
    <select name="branch_id" class="form-control" onchange="this.form.submit()">
      <option value="" {% if selected_branch_id is none or selected_branch_id=='' %}selected{% endif %}>-- Tous les
        Magasins --</option>
      {% for b in branches %}
      <option value="{{ b.id }}" {% if selected_branch_id and selected_branch_id|string==b.id|string %}selected{% endif
        %}>
        {{ b.name }} ({{ b.city }})
      </option>
      {% endfor %}
    </select>
  </form>
</div>
{% endif %}

<div class="card form-card">
  <h3><i class="fa-solid fa-user-plus"></i> Ajouter un Nouvel Employé</h3>
  <form method="post" action="{{ request.url_for('employees_create') }}">
    <div class="form-row">
      <div class="form-group">
        <label for="first_name">Prénom</label>
        <input type="text" id="first_name" name="first_name" required placeholder="Prénom de l'employé">
      </div>
      <div class="form-group">
        <label for="last_name">Nom</label>
        <input type="text" id="last_name" name="last_name" required placeholder="Nom de famille">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="cin">N° CIN</label>
        <input type="text" id="cin" name="cin" placeholder="Numéro de Carte d'Identité" pattern="\d*"
          title="Doit contenir uniquement des chiffres">
      </div>
      <div class="form-group">
        <label for="position">Poste</label>
        <input type="text" id="position" name="position" required placeholder="Ex: Vendeur, Gérant, etc.">
      </div>
    </div>
    <div class="form-row">
      {# --- PERMISSION : Champ Salaire visible par l'admin seulement --- #}
      <div class="form-group">
        <label for="salary">Salaire de Base (TND)</label>
        <input type="text" id="salary" name="salary" placeholder="Ex: 1200.00" pattern="^\d+([.,]\d{1,2})?$"
          title="Montant positif, ex: 1200 ou 1200.50">
      </div>
      <div class="form-group">
        <label for="branch_id">Magasin</label>
        {% if (not user.permissions.is_admin) and manager_branch_id %}
        <input type="hidden" name="branch_id" value="{{ manager_branch_id }}">
        <p><strong>Magasin :</strong>
          {% for b in branches %}
          {% if b.id == manager_branch_id %} {{ b.name }} ({{ b.city }}) {% endif %}
          {% endfor %}
        </p>
        {% elif user.permissions.is_admin %}
        <select id="branch_id" name="branch_id" required>
          <option value="" disabled selected>-- Choisir un magasin --</option>
          {% for b in branches %}
          <option value="{{ b.id }}">{{ b.name }} ({{ b.city }})</option>
          {% endfor %}
        </select>
        {% endif %}
      </div>
      <div class="form-group d-flex align-items-end">
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="has_cnss" name="has_cnss" value="true">
          <label class="form-check-label" for="has_cnss"><strong>CNSS ?</strong></label>
        </div>
      </div>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-plus"></i> Ajouter Employé
      </button>
    </div>
  </form>
</div>


<div class="card table-card">
  <h3><i class="fa-solid fa-list-ul"></i> Liste des Employés</h3>
  {% if employees %}
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Prénom</th>
          <th>Nom</th>
          <th>N° CIN</th>
          <th>Poste</th>
          <th>CNSS</th>
          <th>Salaire (TND)</th>
          <th>Magasin</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for e in employees %}
        <tr>
          <td>{{ e.id }}</td>
          <td>{{ e.first_name }}</td>
          <td>{{ e.last_name }}</td>
          <td>{{ e.cin or '-' }}</td>
          <td>{{ e.position }}</td>
          <td>
            {% if e.has_cnss %}
            <span class="badge" style="background-color: #2e7d32; color: white;">Oui</span>
            {% else %}
            <span class="badge" style="background-color: #757575; color: white;">Non</span>
            {% endif %}
          </td>
          <td class="amount">
            {% if e.salary %}{{ "%.2f"|format(e.salary|float) }}{% else %}-{% endif %}
          </td>
          <td>
            {% for b in branches %}
            {% if b.id == e.branch_id %}
            {{ b.name }}
            {% endif %}
            {% endfor %}
          </td>
          <td>
            {% if e.active %}
            <span class="badge status-active">Actif</span>
            {% else %}
            <span class="badge status-inactive">Inactif</span>
            {% endif %}
          </td>
          <td>
            <a href="{{ request.url_for('employee_report_index') }}?employee_id={{ e.id }}"
              class="btn btn-primary btn-sm">
              <i class="fa-solid fa-eye"></i> Détails
            </a>
            <!-- BOUTON MODIFIER (Updated for single modal) -->
            <button type="button" class="btn btn-warning btn-sm" style="color: #fff;" data-bs-toggle="modal"
              data-bs-target="#editEmployeeModal" data-id="{{ e.id }}" data-firstname="{{ e.first_name }}"
              data-lastname="{{ e.last_name }}" data-cin="{{ e.cin or '' }}" data-position="{{ e.position }}"
              data-salary="{{ '%.2f'|format(e.salary|float) if e.salary else '' }}" data-branch="{{ e.branch_id }}"
              data-cnss="{{ 'true' if e.has_cnss else 'false' }}">
              <i class="fa-solid fa-pen"></i> Modifier
            </button>
            <form method="post" action="{{ request.url_for('employees_delete', employee_id=e.id) }}"
              style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer cet employé ?');">
                <i class="fa-solid fa-trash"></i> Supprimer
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="no-data">Aucun employé à afficher.</p>
  {% endif %}
</div>

<!-- GLOBAL EDIT MODAL -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: var(--bg-elev); color: var(--text);">
      <div class="modal-header">
        <h5 class="modal-title">Modifier Employé</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Action set via JS -->
        <form id="editEmployeeForm" method="post" action="">
          <div class="form-row">
            <div class="form-group">
              <label>Prénom</label>
              <input type="text" id="edit_first_name" name="first_name" required class="form-control">
            </div>
            <div class="form-group">
              <label>Nom</label>
              <input type="text" id="edit_last_name" name="last_name" required class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>N° CIN</label>
              <input type="text" id="edit_cin" name="cin" class="form-control">
            </div>
            <div class="form-group">
              <label>Poste</label>
              <input type="text" id="edit_position" name="position" required class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Salaire (TND)</label>
              <input type="text" id="edit_salary" name="salary" class="form-control">
            </div>
            <div class="form-group">
              <label>Magasin</label>
              {% if user.permissions.is_admin %}
              <select id="edit_branch_id" name="branch_id" class="form-select">
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
              {% else %}
              <input type="hidden" id="edit_branch_id_hidden" name="branch_id" value="">
              <input type="text" id="edit_branch_display" class="form-control" disabled>
              {% endif %}
            </div>
          </div>
          <div class="form-group mt-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="edit_has_cnss" name="has_cnss" value="true">
              <label class="form-check-label">CNSS ?</label>
            </div>
          </div>

          <div class="modal-footer" style="padding-bottom: 0;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Populate Modal on Show
  const editModal = document.getElementById('editEmployeeModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', event => {
      // Button that triggered the modal
      const button = event.relatedTarget;

      // Extract info from data-* attributes
      const id = button.getAttribute('data-id');
      const firstName = button.getAttribute('data-firstname');
      const lastName = button.getAttribute('data-lastname');
      const cin = button.getAttribute('data-cin');
      const position = button.getAttribute('data-position');
      const salary = button.getAttribute('data-salary');
      const branchId = button.getAttribute('data-branch');
      const cnss = button.getAttribute('data-cnss') === 'true';

      // Update Form Action
      const form = document.getElementById('editEmployeeForm');
      form.action = `/employees/${id}/update`;

      // Update Inputs
      document.getElementById('edit_first_name').value = firstName;
      document.getElementById('edit_last_name').value = lastName;
      document.getElementById('edit_cin').value = cin;
      document.getElementById('edit_position').value = position;
      document.getElementById('edit_salary').value = salary;

      // Update Checkbox
      document.getElementById('edit_has_cnss').checked = cnss;

      // Update Branch logic
      const branchSelect = document.getElementById('edit_branch_id');
      if (branchSelect) {
        // Admin: Select option
        branchSelect.value = branchId;
      } else {
        // Non-Admin: Set hidden input and display text
        document.getElementById('edit_branch_id_hidden').value = branchId;
        // Find branch name from DOM references or basic logic? 
        // Simpler: Just rely on the pre-filled value if we passed branchName, OR just show "Votre Magasin"
        // Better: Pass branch NAME in data attribute too.
      }
    });
  }
</script>
{% endblock %}