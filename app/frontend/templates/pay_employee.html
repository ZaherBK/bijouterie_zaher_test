{% extends "base.html" %}

{% block content %}
<h2 class="page-title">
  <i class="fa-solid fa-hand-holding-dollar"></i> Enregistrer un Paiement
</h2>


{% if user.permissions.is_admin %}
<div class="card form-card mb-4" style="border-left: 5px solid #2196f3;">
  <h3><i class="fa-solid fa-filter"></i> Filtrer par Magasin (Admin)</h3>
  <form method="get" action="{{ request.url_for('pay_employee_page') }}">
    <select name="branch_id" class="form-control" onchange="this.form.submit()">
      <option value="" {% if not selected_branch_id %}selected{% endif %}>-- Tous les Magasins --</option>
      {% for b in branches %}
      <option value="{{ b.id }}" {% if selected_branch_id|string==b.id|string %}selected{% endif %}>
        {{ b.name }} ({{ b.city }})
      </option>
      {% endfor %}
    </select>
  </form>
</div>
{% endif %}

<div class="card form-card">
  <h3><i class="fa-solid fa-file-invoice-dollar"></i> Nouveau Paiement</h3>
  <form method="post" action="{{ request.url_for('pay_employee_action') }}">
    <div class="form-row">
      <div class="form-group">
        <label for="employee_id">Employé</label>
        <select id="employee_id" name="employee_id" class="form-select" required>
          <option value="" disabled selected>-- Choisir un employé --</option>
          {% for e in employees %}
          <option value="{{ e.id }}">
            {{ e.first_name }} {{ e.last_name }}
            (Salaire: {{ "%.2f TND"|format(e.salary|float) if e.salary else 'N/A' }})
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="amount">Montant Payé (TND)</label>
        <input type="number" id="amount" name="amount" class="form-control" required placeholder="Ex: 1200.00"
          step="0.01" min="0" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="date">Date du Paiement</label>
        <input type="date" id="date" name="date" class="form-control" required value="{{ today_date }}" />
      </div>

      <div class="form-group">
        <label for="pay_type">Type de Paiement</label>
        <select id="pay_type" name="pay_type" class="form-select" required>
          <option value="mensuel">Mensuel</option>
          <option value="hebdomadaire">Hebdomadaire</option>
          <!-- Ligne "Avance" supprimée comme demandé -->
          <option value="prime_rendement">Prime de Rendement</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <label for="note">Note (Optionnel)</label>
        <input type="text" id="note" name="note" class="form-control" placeholder="Ex: Salaire Octobre, Prime..." />
      </div>
    </div>

    <div class="form-actions" style="margin-top: 1rem;">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-save"></i> Enregistrer Paiement
      </button>
    </div>
  </form>
</div>

{% with default_coddep=2 %}
{% include "sync_partial.html" %}
{% endwith %}

<!-- ===== Tableau des paiements récents ===== -->
<div class="card table-card">
  <h4 class="section-title">
    <i class="fa-solid fa-clock-rotate-left"></i> Paiements Récents
  </h4>
  <div class="section-body">
    {% if recent_payments and recent_payments|length > 0 %}
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Employé</th>
            <th>Date</th>
            <th>Type</th>
            <th>Montant (TND)</th>
            <th>Note</th>
            <th>Créé par</th>
          </tr>
        </thead>
        <tbody>
          {% for p in recent_payments %}
          <tr>
            <td>{{ p.employee.first_name }} {{ p.employee.last_name }}</td>
            <td class="timestamp">{{ p.date.strftime('%Y-%m-%d') }}</td>
            <td>
              {% if p.pay_type.value == 'mensuel' %}
              <span class="badge action-pay">
                <i class="fa-solid fa-coins"></i> Mensuel
              </span>
              {% elif p.pay_type.value == 'hebdomadaire' %}
              <span class="badge action-pay">
                <i class="fa-solid fa-calendar-week"></i> Hebdomadaire
              </span>
              {% elif p.pay_type.value == 'avance' %}
              <span class="badge action-deposit">
                <i class="fa-solid fa-hand-holding-dollar"></i> Avance
              </span>
              {% elif p.pay_type.value == 'prime_rendement' %}
              <span class="badge badge-prime">
                <i class="fa-solid fa-award"></i> Prime
              </span>
              {% else %}
              <span class="badge status-inactive">{{ p.pay_type.value }}</span>
              {% endif %}
            </td>
            <td class="amount">{{ "%.2f"|format(p.amount|float) }}</td>
            <td>{{ p.note or '-' }}</td>
            <td>{{ p.creator.full_name if p.creator else 'Système' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="no-data" style="padding: 1rem;">
      Aucun paiement récent enregistré.
    </p>
    {% endif %}
  </div>
</div>
{% endblock %}